<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GitHub Actions Test Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    h1 { text-align: center; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; max-width: 1000px; margin: 0 auto; }
    canvas { max-width: 600px; margin: 0 auto; display: block; }
    table { width:100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align:left; }
    th { background:#f6f6f6; }
  </style>
</head>
<body>
  <h1>Test Results Dashboard</h1>
  <div class="grid">
    <canvas id="resultsChart"></canvas>
    <div>
      <h3>Summary</h3>
      <table>
        <tbody id="summaryRows"></tbody>
      </table>
    </div>
  </div>

  <script>
    async function loadAndVisualize() {
      // Fetch the XML report generated by the workflow
      const res = await fetch('test-results.xml');
      const xml = await res.text();
      const doc = new DOMParser().parseFromString(xml, 'application/xml');

      // Extract all testcase elements
      const testcases = Array.from(doc.getElementsByTagName('testcase'));
      let passed = 0, failed = 0, errors = 0, skipped = 0;
      testcases.forEach(tc => {
        if (tc.getElementsByTagName('failure').length > 0) {
          failed++;
        } else if (tc.getElementsByTagName('error').length > 0) {
          errors++;
        } else if (tc.getElementsByTagName('skipped').length > 0) {
          skipped++;
        } else {
          passed++;
        }
      });
      const total = testcases.length;

      // Populate the summary table
      const rows = [
        ['Total', total],
        ['Passed', passed],
        ['Failed', failed],
        ['Errors', errors],
        ['Skipped', skipped],
      ];
      document.getElementById('summaryRows').innerHTML =
        rows.map(([k, v]) => `<tr><th>${k}</th><td>${v}</td></tr>`).join('');

      // Draw the bar chart using Chart.js
      const ctx = document.getElementById('resultsChart');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Passed', 'Failed', 'Errors', 'Skipped'],
          datasets: [{
            label: 'Test Results',
            data: [passed, failed, errors, skipped]
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          },
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Results from testâ€‘results.xml' }
          }
        }
      });
    }
    loadAndVisualize();
  </script>
</body>
</html>
